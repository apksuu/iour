name: Telegram Bot VM (5 Hours)

on: 
  workflow_dispatch: # å…è®¸åœ¨ GitHub ç½‘é¡µä¸Šæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  run-vm:
    runs-on: ubuntu-latest
    steps:
      - name: âš™ï¸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–åº“
        run: pip install python-telegram-bot nest_asyncio

      - name: ğŸ¤– å¯åŠ¨ Telegram æ§åˆ¶æœºå™¨äºº (å¸¦è®°å¿†åŠŸèƒ½)
        run: |
          cat << 'EOF' > bot.py
          import asyncio
          import subprocess
          import sys
          import os
          from telegram import Update
          from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

          # ä½ çš„ Bot Token (æµ‹è¯•å®Œå»ºè®®å» @BotFather é‡æ–°ç”Ÿæˆå¹¶ä½¿ç”¨ GitHub Secrets éšè—)
          TOKEN = '8310173625:AAGjhP7DOW-xpad6W5UUVNb0g0VC70D6ww4'

          async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
              welcome_msg = (
                  "âœ… GitHub Actions è™šæ‹Ÿæœºå·²è¿æ¥ï¼\n"
                  "ç°åœ¨æ‚¨å¯ä»¥ç›´æ¥å‘é€ Linux å‘½ä»¤ã€‚\n"
                  "ğŸ’¡ å·²ç»æ”¯æŒ `cd` å‘½ä»¤ï¼Œæˆ‘ä¼šè®°ä½æ‚¨å½“å‰çš„ç›®å½•çŠ¶æ€ï¼\n\n"
                  "â³ è®¡åˆ’è¿è¡Œæ—¶é•¿ï¼š5å°æ—¶\n"
                  "ğŸ›‘ è¾“å…¥ /stop å¯éšæ—¶æå‰å…³é—­è™šæ‹Ÿæœºã€‚"
              )
              await update.message.reply_text(welcome_msg)

          async def stop(update: Update, context: ContextTypes.DEFAULT_TYPE):
              await update.message.reply_text("ğŸ›‘ æ”¶åˆ°å…³é—­æŒ‡ä»¤ï¼Œæ­£åœ¨é”€æ¯ GitHub Actions è™šæ‹Ÿæœº...")
              sys.exit(0) # é€€å‡º Python è„šæœ¬ï¼ŒGitHub Actions ä»»åŠ¡ä¹Ÿä¼šéšä¹‹ç»“æŸ

          async def handle_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
              cmd = update.message.text.strip()
              
              # ã€æ ¸å¿ƒé€»è¾‘ã€‘ï¼šæ‹¦æˆªå¹¶å¤„ç† cd å‘½ä»¤ï¼Œè®© Python è®°ä½å½“å‰è·¯å¾„
              if cmd.startswith("cd "):
                  target_dir = cmd[3:].strip()
                  try:
                      # æ”¹å˜ Python è¿è¡Œæ—¶çš„å½“å‰å·¥ä½œç›®å½•
                      os.chdir(target_dir)
                      current_dir = os.getcwd()
                      await update.message.reply_text(f"ğŸ“ ç›®å½•å·²åˆ‡æ¢è‡³:\n{current_dir}")
                  except FileNotFoundError:
                      await update.message.reply_text(f"âŒ æ‰¾ä¸åˆ°ç›®å½•: {target_dir}")
                  except Exception as e:
                      await update.message.reply_text(f"âŒ åˆ‡æ¢ç›®å½•å¤±è´¥: {str(e)}")
                  return # cd å‘½ä»¤å¤„ç†å®Œæ¯•ï¼Œç›´æ¥è¿”å›

              # å¤„ç†å…¶ä»–å¸¸è§„å‘½ä»¤
              try:
                  # cwd=os.getcwd() ç¡®ä¿æ¯æ¬¡æ‰§è¡Œå‘½ä»¤éƒ½åœ¨æˆ‘ä»¬â€œè®°ä½â€çš„ç›®å½•ä¸‹
                  process = subprocess.Popen(cmd, shell=True, cwd=os.getcwd(), stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
                  stdout, stderr = process.communicate(timeout=60) # è®¾ç½®è¶…æ—¶æ—¶é—´ 60 ç§’
                  
                  output = stdout + stderr
                  if not output.strip():
                      output = "[å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œæ— è¾“å‡º]"
                  
                  # Telegram å•æ¡æ¶ˆæ¯æœ€é•¿ 4096 å­—ç¬¦ï¼Œè¿›è¡Œæˆªæ–­ä¿æŠ¤
                  if len(output) > 4000:
                      output = output[:4000] + "\n...[è¾“å‡ºè¿‡é•¿å·²æˆªæ–­]"
                  
                  await update.message.reply_text(f"ğŸ’» æ‰§â¾:\n{cmd}\n\nğŸ“„ ç»“æœ:\n{output}")
                  
              except subprocess.TimeoutExpired:
                  await update.message.reply_text("âŒ å‘½ä»¤æ‰§è¡Œè¶…æ—¶ (è¶…è¿‡60ç§’è¢«å¼ºåˆ¶ç»ˆæ­¢)")
              except Exception as e:
                  await update.message.reply_text(f"âŒ å‘ç”Ÿé”™è¯¯: {str(e)}")

          async def main():
              app = ApplicationBuilder().token(TOKEN).build()
              
              app.add_handler(CommandHandler("start", start))
              app.add_handler(CommandHandler("stop", stop))
              app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_command))
              
              print("Telegram Bot å¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨ç›‘å¬å‘½ä»¤...")
              await app.initialize()
              await app.start()
              await app.updater.start_polling()
              
              # ä¿æŒè¿è¡Œ 5 å°æ—¶ (18000ç§’)
              await asyncio.sleep(18000)
              
              print("å·²è¾¾åˆ° 5 å°æ—¶æ—¶é•¿é™åˆ¶ï¼Œå‡†å¤‡å…³é—­...")
              await app.updater.stop()
              await app.stop()
              await app.shutdown()

          if __name__ == '__main__':
              asyncio.run(main())
          EOF
          
          # è¿è¡Œç”Ÿæˆçš„ Python è„šæœ¬
          python bot.py
