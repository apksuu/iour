name: Telegram Bot VM (5 Hours)

on: 
  workflow_dispatch: # å…è®¸åœ¨ GitHub ç½‘é¡µä¸Šæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  run-vm:
    runs-on: ubuntu-latest
    steps:
      - name: âš™ï¸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–åº“
        run: pip install python-telegram-bot nest_asyncio

      - name: ğŸ¤– å¯åŠ¨ Telegram æ§åˆ¶æœºå™¨äºº (è¿è¡Œ5å°æ—¶)
        run: |
          cat << 'EOF' > bot.py
          import asyncio
          import subprocess
          import sys
          from telegram import Update
          from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

          # å¡«å…¥ä½ æä¾›çš„ Bot Token
          TOKEN = '8310173625:AAGjhP7DOW-xpad6W5UUVNb0g0VC70D6ww4'

          async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
              welcome_msg = (
                  "âœ… GitHub Actions è™šæ‹Ÿæœºå·²è¿æ¥ï¼\n"
                  "ç°åœ¨æ‚¨å¯ä»¥ç›´æ¥å‘é€ Linux å‘½ä»¤ (ä¾‹å¦‚ `ls -la`, `uname -a`, `curl ifconfig.me`)ã€‚\n"
                  "æˆ‘ä¼šå¸®æ‚¨åœ¨è™šæ‹Ÿæœºæ‰§è¡Œå¹¶è¿”å›ç»“æœã€‚\n\n"
                  "â³ è®¡åˆ’è¿è¡Œæ—¶é•¿ï¼š5å°æ—¶\n"
                  "ğŸ›‘ è¾“å…¥ /stop å¯éšæ—¶æå‰å…³é—­è™šæ‹Ÿæœºã€‚"
              )
              await update.message.reply_text(welcome_msg)

          async def stop(update: Update, context: ContextTypes.DEFAULT_TYPE):
              await update.message.reply_text("ğŸ›‘ æ”¶åˆ°å…³é—­æŒ‡ä»¤ï¼Œæ­£åœ¨é”€æ¯ GitHub Actions è™šæ‹Ÿæœº...")
              sys.exit(0) # é€€å‡º Python è„šæœ¬ï¼ŒGitHub Actions ä»»åŠ¡ä¹Ÿä¼šéšä¹‹ç»“æŸ

          async def handle_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
              cmd = update.message.text
              try:
                  # åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œ Bash å‘½ä»¤
                  process = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
                  stdout, stderr = process.communicate(timeout=60) # è®¾ç½®å•æ¡å‘½ä»¤è¶…æ—¶æ—¶é—´ä¸º60ç§’
                  
                  output = stdout + stderr
                  if not output.strip():
                      output = "[å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œæ— è¾“å‡º]"
                  
                  # Telegram å•æ¡æ¶ˆæ¯æœ€é•¿ 4096 å­—ç¬¦ï¼Œè¿›è¡Œæˆªæ–­ä¿æŠ¤
                  if len(output) > 4000:
                      output = output[:4000] + "\n...[è¾“å‡ºè¿‡é•¿å·²æˆªæ–­]"
                  
                  await update.message.reply_text(f"ğŸ’» æ‰§â¾:\n{cmd}\n\nğŸ“„ ç»“æœ:\n{output}")
                  
              except subprocess.TimeoutExpired:
                  await update.message.reply_text("âŒ å‘½ä»¤æ‰§è¡Œè¶…æ—¶ (è¶…è¿‡60ç§’è¢«å¼ºåˆ¶ç»ˆæ­¢)")
              except Exception as e:
                  await update.message.reply_text(f"âŒ å‘ç”Ÿé”™è¯¯: {str(e)}")

          async def main():
              app = ApplicationBuilder().token(TOKEN).build()
              
              app.add_handler(CommandHandler("start", start))
              app.add_handler(CommandHandler("stop", stop))
              app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_command))
              
              print("Telegram Bot å¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨ç›‘å¬å‘½ä»¤...")
              await app.initialize()
              await app.start()
              await app.updater.start_polling()
              
              # æ ¸å¿ƒï¼šè®©è„šæœ¬ä¿æŒè¿è¡Œ 5 å°æ—¶ (5å°æ—¶ * 60åˆ†é’Ÿ * 60ç§’ = 18000ç§’)
              await asyncio.sleep(18000)
              
              print("å·²è¾¾åˆ° 5 å°æ—¶æ—¶é•¿é™åˆ¶ï¼Œå‡†å¤‡å…³é—­...")
              await app.updater.stop()
              await app.stop()
              await app.shutdown()

          if __name__ == '__main__':
              asyncio.run(main())
          EOF
          
          # è¿è¡Œæˆ‘ä»¬åˆšåˆšç”Ÿæˆçš„ Python è„šæœ¬
          python bot.py
